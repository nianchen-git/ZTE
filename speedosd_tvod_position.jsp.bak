<%@page contentType="text/html; charset=GBK" %>
<%@taglib uri="/WEB-INF/epgtag.tld" prefix="epg" %>
<%@ page import="com.zte.iptv.epg.util.STBKeysNew" %>
<%@ page import="com.zte.iptv.newepg.datasource.VodOneDataSource" %>
<%@ page import="com.zte.iptv.epg.web.VoDQueryValueIn" %>
<%@ page import="com.zte.iptv.epg.account.UserInfo" %>
<%@ page import="com.zte.iptv.epg.util.EpgConstants" %>
<%@ page import="com.zte.iptv.epg.EpgException" %>
<%@ page import="com.zte.iptv.epg.web.Result" %>
<%@ page import="com.zte.iptv.epg.content.VoDContentInfo" %>
<%@ page import="java.net.URLDecoder" %>
<%@ page import="com.zte.iptv.newepg.datasource.EpgResult" %>
<%@ page import="com.zte.iptv.epg.web.VodContentInfoValueIn" %>
<%@ page import="com.zte.iptv.newepg.datasource.VodQueryDataSource" %>
<epg:PageController/>
<html>
<%!
    public String getPath(String uri) {
        String path = "";
        int begin = 0;
        int end = uri.lastIndexOf('/');
        if (end > 0) {
            path = uri.substring(begin, end + 1) + path;
        }
        return path;
    }

    public String getVodConInf(String columnId, String contentId, PageContext pageContext) {
        VoDContentInfo vodConInf = null;
        try {
            UserInfo userInfoForFav = (UserInfo) pageContext.getSession().getAttribute(EpgConstants.USERINFO);
            VodQueryDataSource vodDs = new VodQueryDataSource();
            VodContentInfoValueIn vodValueIn = (VodContentInfoValueIn) vodDs.getValueIn();
            vodValueIn.setSubjectCode(columnId);
            vodValueIn.setUserInfo(userInfoForFav);
            vodValueIn.setContentCode(contentId);
            EpgResult result = vodDs.getData();
            vodConInf = (VoDContentInfo) result.getData();
        } catch (Exception ex) {
            ex.printStackTrace();
        }
        return vodConInf.getProgramName();
    }
%>
<%
    String type = request.getParameter("fast");
//    String columnid = request.getParameter("columnid");
//    String contentid = request.getParameter("contentid");
//    String programname = getVodConInf(columnid, contentid, pageContext);

    String imgRR = "images/vod/btv-02-left.png";
    String imgPP = "images/vod/btv-02-pause.png";
    String imgFF = "images/vod/btv-02-right.png";
    int topRR = 20;
    int topPP = 15;
    int topFF = 20;

    if ("RR".equals(type)) {
        imgRR = "images/vod/btv-02-leftc.png";
        topRR = 15;
    } else if ("pause".equals(type)) {
        imgPP = "images/vod/btv-02-pausec.png";
        topPP = 10;
    } else if ("FF".equals(type)) {
        imgFF = "images/vod/btv-02-rightc.png";
        topFF = 15;
    }

%>

<body bgcolor="transparent" onLoad="pageInit();">

<%--下方进度条背景图片--%>

<div id="pro">
    <div style="left:0; top:574;width:1280;height:146; position:absolute;">
        <div style="left:0; top:0;width:1200;height:146; position:absolute">
            <img src="images/vod/btv-02-progressbg.png" border="0" width="1280" height="146" alt=""/>
        </div>
    </div>
    <!--状态图标(快进、快退、暂停)-->
    <div style="left:0; top:574;width:1280;height:146; position:absolute;">
        <div id="div0" style="left:105; top:<%=topRR%>;width:68;height:68; position:absolute;" align="center">
            <img id="img0" src="<%=imgRR%>" border="0" alt=""/>
        </div>

        <div id="div1" style="left:173; top:<%=topPP%>;width:83;height:83; position:absolute;" align="center">
            <img id="img1" src="<%=imgPP%>" border="0" alt=""/>
        </div>

        <div id="div2" style="left:258; top:<%=topFF%>;width:68;height:68; position:absolute;" align="center">
            <img id="img2" src="<%=imgFF%>" border="0" alt=""/>
        </div>
    </div>

    <!--当前时间和结束时间-->
    <div style="left:1030; top:615;width:80;height:27; position:absolute;font-size:22px;color:#FFFFFF"
         id="currentTimeDiv"></div>
    <div style="left:1100; top:615;width:50;height:27;font-size:22px; position:absolute;color:#FFFFFF" id="endTimeDiv">
    </div>
    <!--快进货快退倍数(2X)-->
    <div align="right" style="left:325; top:590;width:40;height:27;font-size:22px;color:#FFFFFF; position:absolute"
         id="speedDiv">
    </div>
    <!--进度条-->
    <div style="left:340; top:625;width:680;height:3; position:absolute;">
        <img id="speedBarDiv" src="images/vod/btv-02-progressred.png" width="4" height="3" alt="">
    </div>
    <div id="icon" style="left:337; top:615;width:26;height:26; position:absolute; ">
        <img src="images/vod/btv-02-progressico.png" alt="" width="26" height="26" border="0">
    </div>


    <%--<!--收藏-->--%>
    <%--<div style="left:105; top:666;width:500;height:31; position:absolute;font-size:22px;color:#FFFFFF">--%>
        <%--<img src="images/vod/btv_Collection.png" alt="" border="0"/>--%>
        <%--<font style="position:absolute;left:70;top:5;;width:400">按红色按钮为收藏</font>--%>
    <%--</div>--%>
    <%--<!--书签-->--%>
    <%--<div style="left:360; top:666;width:200;height:31; position:absolute;">--%>
        <%--<div id="point" style="left:0; top:0;width:200;height:31; position:absolute;font-size:22px;color:#FFFFFF;visibility:hidden">--%>
            <%--<img src="images/vod/btn_break_point.png" alt="" border="0"/>--%>
            <%--<font style="position:absolute;left:70;top:5;;width:100">书签</font>--%>
        <%--</div>--%>
    <%--</div>--%>
    <!---定时播放-->
    <div id="locdiv" style="left:1050; top:660;width:200;height:31; position:absolute;font-size:20px;visibility:hidden;">
        <div  style="left:-60; top:0;width:80;height:28; position:absolute;color:#FFFFFF;">跳转至</div>
        <div id="loc0" style="left:10; top:0;width:28;height:28; position:absolute;color:#FFFFFF;border:1px solid #333333">00</div>
        <div style="left:47; top:0;width:30;height:28; position:absolute;color:#FFFFFF;">:</div>

        <div id="loc1" style="left:60; top:0;width:28;height:28; position:absolute;color:#FFFFFF;border:1px solid #333333">00</div>

        <div id="line" style="left:22; top:0;width:30;height:28; position:absolute;font-size:30px;color:#FFFFFF;">
            
        </div>
    </div>

    <!--收藏提示信息-->
    <div style="left:420px; top:229px;width:568px;height:215px; position:absolute;z-index:2000">
        <div id="msg" style="left:0px; top:0px;width:394px;height:215px; position:absolute;visibility:hidden;">
            <div style="left:0px;top:0px;width:394px;height:200px;position:absolute;">
                <img src="images/vod/btv10-2-bg01.png" alt="" width="394" height="215" border="0"/>
            </div>
            <div id="text" style="left:0px;top:70px;width:394px;height:34px;z-index:6;font-size:20px;color:#FFFFFF;position:absolute;" align="center">

            </div>
            <div id="closeMsg" style="left:0px;top:160px;width:394px;height:34px;z-index:6;font-size:20px;color:#FFFFFF;position:absolute;" align="center">
                2秒自动关闭
            </div>
        </div>
    </div>
</div>
<div id="locTime" style="left:1100; top:30;width:30;height:28; position:absolute;font-size:30px;color:#FFFFFF;visiblity:hidden">

</div>
</body>
<script type="text/javascript" src="js/contentloader.js"></script>
<script type="text/javascript">
var $$ = {};
var timer=-1;
var toptimer=-1;
var $ = function(id) {
    if (!$$[id]) {
        $$[id] = document.getElementById(id);
    }
    return $$[id];
}
var index = 0;
var leftarr = [22,72];
function onkeypress(evt) {
    var keyCode = parseInt(evt.which);
    if (keyCode == 0x0028) { }//onKeyDown
    else if (keyCode == 0x0026) { } //onKeyUp
    else if (keyCode == 0x0025) { //onKeyLeft
        onLeft();
}else if (keyCode == 0x0008  || keyCode == 24) {  //back
//            pageOnKeyOK();
       // alert("SSSSSSSSSSSSSSSSback!!!");
        return false;
    } else if (keyCode == 0x0027) { //onKeyRight
        onRight();
    }else if(keyCode == 0x0109){ // remind
        //checkPress();
//        document.getElementById("point").style.visibility="hidden";
        pageFastRewind();
    } else if(keyCode == 0x0108){ //reForard
        //checkPress();
//        document.getElementById("point").style.visibility="hidden";
        pageFastForword();
    } else if (keyCode == 0x000D) {  //OK
        locationPlay();
    }else if(keyCode == 0x0107){
        pagePlayPause();
    }else if(keyCode == 0x0114){
//        if(type == "pause"){
//            addMark();
//        }
    } else if (keyCode >= 0x30 && keyCode <= 0x39){
        onKeyNumChar(keyCode);
    }else if(keyCode==0x0113){ //red favorite
//        favoritedo();
    } else {
        top.doKeyPress(evt);
        return true;
    }
    return false;
}
function locationPlay() {
    var duration = parseInt(top.jsDoGetVODTimeInfo());
    var hours = document.getElementById("loc0").innerHTML;
    var min = document.getElementById("loc1").innerHTML;
    var inputTime = parseInt(hours,10) * 3600 + parseInt(min,10) * 60;
    if (inputTime >= 0 && inputTime <= duration)
    {
        top.jsDoSeekTargetTime(1, inputTime);
        document.getElementById("pro").style.visibility="hidden";
        document.getElementById("locdiv").style.visibility="hidden";
        document.getElementById("locTime").innerHTML=hours+":"+min;
        document.getElementById("locTime").style.visibility="visible";

        clearTimeout(toptimer);
        toptimer = setTimeout(hiddenTop, 3000);
    }else{
        $("text").innerHTML = "您输入的时间超出范围！";
        $("msg").style.visibility = "visible";
        $("closeMsg").style.visibility = "visible";
        clearTimeout(timer);
        timer = setTimeout(closeMessage, 2000);
    }
}
function hiddenTop(){
    document.getElementById("locTime").innerHTML="";
    document.getElementById("locTime").style.visibility="hidden";
    top.jsDoResume();
    top.jsHideOSD();
    clearTimeout(toptimer);
}
function onLeft() {
    if (index > 0 && index <= 1) {
        var str=document.getElementById("loc"+index).innerHTML;
        if(str.length<1){
            document.getElementById("loc"+index).innerHTML = "0"+str;
        }
        index--;
        document.getElementById("line").style.left = leftarr[index];
    }
}
function onRight() {
    if (index >= 0 && index < 1) {
        var str=document.getElementById("loc"+index).innerHTML;
        if(str.length<1){
            document.getElementById("loc"+index).innerHTML = "0"+str;
        }
        index++;
        document.getElementById("line").style.left = leftarr[index];
    }
}

function onKeyNumChar(keyCode) {
    var channelNum = keyCode - 0x30;
    var value = document.getElementById("loc" + index).innerHTML;
    if (value.length == 2) {
        document.getElementById("loc" + index).innerHTML = "";
        document.getElementById("loc" + index).innerHTML = checkNum(channelNum);
        if(index==0){
            index=1;
            document.getElementById("line").style.left = leftarr[1];
        }
    } else {
        document.getElementById("loc" + index).innerHTML += channelNum;
        if (index < 1) {
            index++;
            document.getElementById("line").style.left = leftarr[index];
        }
    }
}

function checkNum(num) {
    if (index == 0) {
        return "0"+num;
    } else if (index == 1) {
        if (parseInt(num) <= 5) {
            return parseInt(num);
        }else{
            return "0"+parseInt(num);
        }
//        } else if (index == 1) {
//            return num;
//        }
    }
    return "00";
}
function getNumFromInput(textInput) {
    var num = -1;
    if (textInput == "") {
        num = 0;
    } else {
        for (var i = 0; i < textInput.length; i++) {
            if (textInput.charAt(i) < "0" || textInput.charAt(i) > "9") {
                num = -1;
                return num;
            }
        }
        num = parseInt(textInput, 10);
    }
    return num;
}
function checkPress(){
    document.onkeypress=top.doKeyPress;
    document.getElementById("locdiv").style.visibility="hidden";
//    document.getElementById("point").style.visibility="hidden";
}


////添加书签  规避js方法
//function jsSaveFaver()
//{
//    var currentTime = top.mp.getCurrentPlayTime();
//    if (top.configPara["bpBookMarkParm"] != "")
//    {
//        top.refrWin.document.location = top.configPara["BPSaveUrl"] + top.configPara["bpBookMarkParm"] + "&breakpoint=" + currentTime;
////            configPara["bpBookMarkParm"] = "";
//    }
//    else
//    {
//        top.refrWin.document.location = top.configPara["BPSaveUrl"] + "?programid=" + top.configPara["vodProgramid"] + "&breakpoint=" + currentTime;
//    }
//}

//function addMark(){
////        top.jsSaveFaver();
//    alert("SSSSSSSSSSSSSSSSSSmyaddMark!!!!!");
//    jsSaveFaver();
//    $("text").innerText = "添加书签成功";
//    $("msg").style.visibility = "visible";
//    clearTimeout(timer);
//    timer = setTimeout(closeMessage, 2000);
//}
<%--function favoritedo() {--%>
    <%--var favUrl = "action/favorite_add.jsp?SubjectID=<%=columnid%>"--%>
            <%--+ "&ContentID=<%=contentid%>"--%>
            <%--+ "&FavoriteTitle=<%=programname%>";--%>
    <%--var loaderSearch = new net.ContentLoader(encodeURI(favUrl), showMsg);--%>
<%--}--%>
function showMsg() {
    var results = this.req.responseText;
    var tempData = eval("(" + results + ")");
    var dellflag = tempData.requestflag;
    if (dellflag == 0) {
        $("text").innerText = "收藏成功";
        $("msg").style.visibility = "visible";
        $("closeMsg").style.visibility = "visible";
        clearTimeout(timer);
        timer = setTimeout(closeMessage, 2000);
    } else if (dellflag == 2) {
        $("text").innerText = "节目已收藏";
        $("msg").style.visibility = "visible";
        $("closeMsg").style.visibility = "visible";
        clearTimeout(timer);
        timer = setTimeout(closeMessage, 2000);
    } else if (dellflag == 3) {
        $("text").innerText = "您的收藏已达上限";
        $("msg").style.visibility = "visible";
         $("closeMsg").style.visibility = "visible";
        clearTimeout(timer);
        timer = setTimeout(closeMessage, 2000);
    } else {
        $("text").innerText = "收藏失败";
        $("msg").style.visibility = "visible";
        $("closeMsg").style.visibility = "visible";
        clearTimeout(timer);
        timer = setTimeout(closeMessage, 2000);
    }
}
function closeMessage() {
    document.getElementById("loc0").innerHTML = "00";
    document.getElementById("loc1").innerHTML = "00";
    $("text").innerText = "";
    $("msg").style.visibility = "hidden";
$("closeMsg").style.visibility = "hidden";
    clearTimeout(timer);
}
//top.jsSetupKeyFunction("top.mainWin.favoritedo", 0x0113);
</script>

<script language="javascript" type="">
var imgarr = ["images/vod/btv-02-leftc.png","images/vod/btv-02-pausec.png","images/vod/btv-02-rightc.png"];
var imgarr1 = ["images/vod/btv-02-left.png","images/vod/btv-02-pause.png","images/vod/btv-02-right.png"];
var toparr = [20,15,20];

var type = "<%=request.getParameter("fast")%>";
var speed = 1 ;
var flag = 0;
function pageResume() {
    if (top.isPlay() == true) {
        top.pageResume();
        top.mainWin.document.location = "portal.jsp?onlymenu=1";
        top.showOSD(2, 0, 0);
        top.setBwAlpha(0);
        return false;
    }
    return true;
}
top.jsSetupKeyFunction("top.mainWin.pageResume", <%=STBKeysNew.remoteMenu%>);


function pagePlayPause() {
    top.jsDoResume();
    top.jsHideOSD();
}

//在这个页面按OK和按暂停效果是一样的都是重新播放。
function pageOnKeyOK() {
    pagePlayPause();
}

//快进
function pageFastForword() {
    var isFF=false;
    if(type=="RR"  || type=="pause"){
        isFF=true;
    }else{
        isFF=false;
    }
    type = "FF";
    speed = top.getStbPlaySpeed();
    if (speed <= 0 || speed == 64)
    {
        speed = 2;
    }
    else
    {
        speed = speed * 2;
    }
    //top.mp.fastForward(speed);
    top.doFastForward(speed);
    top.mainWin.document.all.speedDiv.innerHTML = speed + "X";
    if(speed==2 && isFF==true){
        changeImg(2, 15);
    }
}

//快退
function pageFastRewind() {
    var isRR=false;
    if(type=="FF" || type=="pause"){
        isRR=true;
    }else{
        isRR=false;
    }
    type = "RR";
    speed = top.getStbPlaySpeed();
    if (speed >= 0 || speed == -64)
    {
        speed = -2;
    }
    else
    {
        speed = speed * 2;
    }
    var nowspeed = -speed;
    top.mainWin.document.all.speedDiv.innerHTML = nowspeed + "X";
    top.doFastRewind(speed);
    if(nowspeed==2 && isRR==true){
        changeImg(0, 15);
    }
}

//展示开始和结束的时间
function pageVODSpeedInitStartAndEnd() {
    var duration = top.jsDoGetVODTimeInfo();
    var VODTimeInfo = parseInt(duration);
    var VODTotalHours = VODTimeInfo / 3600 ;
    VODTotalHours = parseInt(VODTotalHours);
    if (("" + VODTotalHours).length == 1)
    {
        VODTotalHours = "0" + VODTotalHours;
    }
    var StrVODTotalHours = VODTotalHours;
    VODTotalHours = parseInt(VODTotalHours, 10);
    var VODTotalMinutes = (VODTimeInfo - VODTotalHours * 3600) / 60;
    VODTotalMinutes = parseInt(VODTotalMinutes);
    if (("" + VODTotalMinutes).length == 1)
    {
        VODTotalMinutes = "0" + VODTotalMinutes;
    }
    top.mainWin.document.all.endTimeDiv.innerHTML = StrVODTotalHours + ":" + VODTotalMinutes;
}

//刷新当前播放时间
function refreshCurrentTime() {
    // var currentTime = top.mp.getCurrentPlayTime();
    var currentTime = top.jsGetCurrentPlayTime();
    var VODTimeInfo = parseInt(currentTime);
    if (VODTimeInfo == 0)
    {
        top.mainWin.document.all.currentTimeDiv.innerHTML = " / ";
        return;
    }
    var VODTotalHours = VODTimeInfo / 3600 ;
    VODTotalHours = parseInt(VODTotalHours);
    if (("" + VODTotalHours).length == 1)
    {
        VODTotalHours = "0" + VODTotalHours;
    }
    var StrVODTotalHours = VODTotalHours;
    VODTotalHours = parseInt(VODTotalHours, 10);
    var VODTotalMinutes = (VODTimeInfo - VODTotalHours * 3600) / 60;
    VODTotalMinutes = parseInt(VODTotalMinutes);
    if (("" + VODTotalMinutes).length == 1)
    {
        VODTotalMinutes = "0" + VODTotalMinutes;
    }
    top.mainWin.document.all.currentTimeDiv.innerHTML = StrVODTotalHours + ":" + VODTotalMinutes + " / ";
}

//
function setRefreshBarTimer() {
    if (type != "pause")
    {
        pageRefreshBarState();
    }
    setTimeout("setRefreshBarTimer()", 1000);
}

//控制当前播放时间的进度展示
function pageRefreshBarState() {
    var state = top.getStatus();
    if (flag == 3 && state == "Normal Play")
    {
        top.hideOSD();
        return;
    }
    else
    {
        flag += 1;
    }
    var currTime = parseInt(top.jsGetCurrentPlayTime());
    if (currTime == -1)
    {
        return;
    }
    refreshCurrentTime();
    refreshBarLength();
}

//刷新进度条播放长度
function refreshBarLength() {
    var tempCurrentTime = top.jsGetCurrentPlayTime();
    var tempEndTime = top.jsDoGetVODTimeInfo();
    var tempLength = (tempCurrentTime * 680) / tempEndTime;
    tempLength = parseInt(tempLength);
    if (tempLength == 0)
    {
        top.mainWin.document.all.speedBarDiv.style.width = 1;
        top.mainWin.document.all.icon.style.left = 337;
    }
    else if (tempLength >= 680)
    {
        top.mainWin.document.all.speedBarDiv.style.width = 680;
        top.mainWin.document.all.icon.style.left = tempLength+333;
    }
    else
    {
        top.mainWin.document.all.speedBarDiv.style.width = tempLength;
        top.mainWin.document.all.icon.style.left = tempLength+333;
    }
}
function changeImg(index, topvalue) {
    for (var i = 0; i < 3; i++) {
        if (i == index) {
            top.mainWin.document.getElementById("img" + i).src = imgarr[i];
            top.mainWin.document.getElementById("div" + i).style.top = topvalue;
        } else{
            top.mainWin.document.getElementById("img" + i).src = imgarr1[i];
            top.mainWin.document.getElementById("div" + i).style.top = toparr[i];
        }
    }
}
function pageInit() {
    top.jsSetupKeyFunction("top.mainWin.pageFastRewind", 0x0109);
    top.jsSetupKeyFunction("top.mainWin.pageFastForword", 0x0108);
    top.jsSetupKeyFunction("top.mainWin.pageFastRewind", <%=STBKeysNew.onKeyLeft%>);
    top.jsSetupKeyFunction("top.mainWin.pageFastForword", <%=STBKeysNew.onKeyRight%>);


    top.jsSetupKeyFunction("top.mainWin.pageOnKeyOK", 0x000d);
    top.jsSetupKeyFunction("top.mainWin.pagePlayPause", 0x0107);
    if (type == "FF") {
        top.mainWin.document.all.speedDiv.innerHTML = "2X";
    } else if (type == "RR") {
        top.mainWin.document.all.speedDiv.innerHTML = "2X";
    } else if (type == "pause") {
        top.mainWin.document.all.speedDiv.innerHTML = "";
//        document.getElementById("point").style.visibility = "visible";
        pageRefreshBarState();
    }
    document.getElementById("locdiv").style.visibility = "visible";
    document.onkeypress = onkeypress;
    pageVODSpeedInitStartAndEnd();
    setRefreshBarTimer();
}

document.onkeypress = top.doKeyPress;
focus();
</script>
</html>
